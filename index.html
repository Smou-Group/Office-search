<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¨Ø­Ø« Ø§Ù„Ù…ÙƒØªØ¨ / Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª</title>

<style>
  :root{--brand:#0f5c6e;}
  body{font-family: Tahoma, Arial, sans-serif; background:#f7f7f7; padding:20px; margin:0;}

  .card{
    max-width:1100px;
    margin:0 auto;
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    padding:18px;
    position:relative;
  }

  /* ===== Back Button ===== */
  .back-btn{
    position:absolute;
    top:18px;
    right:18px;
    width:42px;
    height:42px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    text-decoration:none;
    font-size:20px;
    font-weight:bold;
    color:#fff;
    background:var(--brand);
    box-shadow:0 6px 18px rgba(0,0,0,.18);
    transition:all .25s ease;
  }
  .back-btn:hover{
    background:#0b4c59;
    transform:translateY(-3px);
  }

  h2{margin:0 0 10px 0;text-align:center}

  .header{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:8px}
  .logo{width:110px;max-width:40vw;height:auto;display:block}
  .brandLine{font-size:13px;color:#666;text-align:center;margin-top:-2px}

  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  input[type="text"]{
    padding:12px 14px;
    min-width:320px;
    border:1px solid #ddd;
    border-radius:10px;
    font-size:16px;
    outline:none
  }
  input[type="text"]:focus{
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(15,92,110,.15)
  }

  .note{color:#666;margin-top:10px;text-align:center}
  .pill{
    display:inline-block;
    background:rgba(15,92,110,.08);
    color:var(--brand);
    padding:6px 10px;
    border-radius:999px;
    font-size:13px
  }

  table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff}
  th,td{border:1px solid #e2e2e2;padding:10px;text-align:right;vertical-align:top}
  th{background:var(--brand);color:#fff;position:sticky;top:0}
  tr:nth-child(even){background:#fafafa}

  .actions{display:flex;gap:8px;justify-content:center;margin-top:10px;flex-wrap:wrap}
  button{border:0;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px}
  .btn2{background:#eee}
  .small{font-size:12px;color:#777;text-align:center;margin-top:8px}
  .hidden{display:none}

  @media print{
    body{background:#fff;padding:0}
    .card{box-shadow:none;border-radius:0;max-width:none;margin:0;padding:0}
    .actions, .row, .small, .back-btn{display:none !important;}
    th{position:static}
    .logo{width:120px}
    @page{margin:12mm;}
  }
</style>
</head>

<body>
  <div class="card">

    <!-- Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ -->
    <a href="https://portal.smougroup.com/" class="back-btn" title="Ø§Ù„Ø±Ø¬ÙˆØ¹">â†</a>

    <div class="header">
      <img class="logo" src="logo.png" alt="SMOU Logo" />
      <div class="brandLine">SMOU GROUP</div>
    </div>

    <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ / Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª</h2>

    <div class="row">
      <input id="search" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨ Ø£Ùˆ Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª (Ù…Ø«Ø§Ù„: Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©)" autocomplete="off" />
    </div>

    <div class="note" id="info">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div class="actions">
      <button class="btn2" id="clearBtn" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
      <button class="btn2" id="printBtn" type="button">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
    </div>

    <table id="table" class="hidden">
      <thead></thead>
      <tbody></tbody>
    </table>

    <div class="small">
      Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù…Ù„Ù office.csv
    </div>
  </div>

<script>
let data = [];
let headers = [];
let SEARCH_COLS = [];

const info = document.getElementById("info");
const table = document.getElementById("table");
const thead = table.querySelector("thead");
const tbody = table.querySelector("tbody");
const searchInput = document.getElementById("search");

const norm = s => (s ?? "")
  .toString()
  .replace(/[\u064B-\u0652]/g, "")
  .trim()
  .replace(/\s+/g, " ")
  .toLowerCase();

function detectSeparator(line){
  const comma = (line.match(/,/g) || []).length;
  const semi  = (line.match(/;/g) || []).length;
  return semi > comma ? ";" : ",";
}

function splitCSVLine(line, sep){
  const res = [];
  let cur = "", inQ = false;
  for (let i=0;i<line.length;i++){
    const ch = line[i];
    if (ch === '"'){
      if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === sep && !inQ){
      res.push(cur);
      cur = "";
    } else {
      cur += ch;
    }
  }
  res.push(cur);
  return res.map(v => v.trim());
}

function parseCSV(text){
  text = text.replace(/\r/g,"").trim();
  const lines = text.split("\n").filter(l => l.trim() !== "");
  if (!lines.length) return {headers:[], rows:[]};

  lines[0] = lines[0].replace(/^\uFEFF/, "");

  const sep = detectSeparator(lines[0]);
  headers = splitCSVLine(lines[0], sep).map(h => h.trim());

  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i], sep);
    const obj = {};
    headers.forEach((h, idx) => obj[h] = (cols[idx] ?? "").trim());
    rows.push(obj);
  }
  return {headers, rows};
}

function detectSearchColumns(){
  const cols = [];
  const contractorExact = headers.find(h => h.trim() === "Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„Ø§Øª");
  const consultantExact = headers.find(h => h.trim() === "Ù…ÙƒØªØ¨ Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±ÙŠ");

  if (contractorExact) cols.push(contractorExact);
  if (consultantExact) cols.push(consultantExact);

  if (!contractorExact){
    const fuzzy = headers.find(h => h.includes("Ù…Ù‚Ø§ÙˆÙ„") || h.includes("Ù…Ù‚Ø§ÙˆÙ„Ø§Øª"));
    if (fuzzy) cols.push(fuzzy);
  }
  if (!consultantExact){
    const fuzzy = headers.find(h => h.includes("Ø§Ø³ØªØ´"));
    if (fuzzy) cols.push(fuzzy);
  }

  return Array.from(new Set(cols)).slice(0,2);
}

function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderTable(rows){
  if (!rows.length){
    table.classList.add("hidden");
    return;
  }
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${escapeHtml(h)}</th>`).join("") + "</tr>";
  tbody.innerHTML = rows.map(r => "<tr>" + headers.map(h => `<td>${escapeHtml(r[h] ?? "")}</td>`).join("") + "</tr>").join("");
  table.classList.remove("hidden");
}

function search(){
  const q = norm(searchInput.value);

  if (!data.length){
    info.textContent = "âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯.";
    renderTable([]);
    return;
  }

  if (!SEARCH_COLS.length){
    info.textContent = "âš ï¸ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø¹Ù…ÙˆØ¯ÙŠ Ø§Ù„Ø¨Ø­Ø«.";
    renderTable([]);
    return;
  }

  if (!q){
    info.innerHTML = `Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨/Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø¨Ø­Ø«. <span class="pill">Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„: ${SEARCH_COLS.join(" + ")}</span>`;
    renderTable([]);
    return;
  }

  const res = data.filter(r => SEARCH_COLS.some(col => norm(r[col]).includes(q)));
  info.innerHTML = res.length ? `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${res.length}` : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬";
  renderTable(res);
}

fetch("office.csv?v=" + Date.now())
  .then(r => {
    if (!r.ok) throw new Error("office.csv not found");
    return r.text();
  })
  .then(text => {
    const parsed = parseCSV(text);
    data = parsed.rows;
    SEARCH_COLS = detectSearchColumns();
    search();
  })
  .catch(() => {
    info.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù office.csv.";
  });

searchInput.addEventListener("input", search);

document.getElementById("clearBtn").addEventListener("click", ()=>{
  searchInput.value = "";
  search();
  searchInput.focus();
});

document.getElementById("printBtn").addEventListener("click", ()=>{
  if (table.classList.contains("hidden")){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
    return;
  }
  window.print();
});
</script>

</body>
</html>
